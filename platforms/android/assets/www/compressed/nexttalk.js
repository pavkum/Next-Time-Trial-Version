window.defaultAlert=alert,window.defaultConfirm=confirm,window.confirm=function(o,e,i,n){var t=$("#modal"),d=$("#overlay"),r=new $.Deferred,s=moduleLoader.loadModule("confirm");s.done(function(o){t.html(o),r.resolve()}),r.promise().done(function(){var r,s=0;if(e){var f=e.position();r=f.top,s=f.left,d.height(e.height())}t.find("#content").html(o),d.css("top",r+"px"),d.css("left",s+"px"),n&&t.addClass(n),i&&d.addClass(i),t.find(".confirmWrapper").css("top",t.find(".confirmWrapper").css("top"));var l=t.find("#close");l.height(l.height()),l.css("top",l.css("top")),$("body").on("confirmClose",function(){t.hide(),d.hide()}),l.on(configuartion.events.userselect,function(o){$(this).off(o),$("body").trigger("triggerHistory")}),t.show();var s=t.width()-l.height()/2;l.css("left",s),d.show()})},window.alert=function(o,e){var i=$("#modal"),n=$("#overlay"),t=new $.Deferred,d=moduleLoader.loadModule("alert");d.done(function(o){i.html(o),t.resolve()}),t.promise().done(function(){e&&i.find("#modalTitle").html(e),i.find("#modalBody").html(o),n.show(),i.show(500),$("body").on("modalClose",function(){i.hide(),n.hide()}),$("#modalClose").on(configuartion.events.userselect,function(o){$(this).off(o),$("body").trigger("triggerHistory")})})},window.notification=function(o){if(o){var e=$("#notification");e.text(o),e.show(250),setTimeout(function(){e.hide(250)},2500)}}; var configuartion={events:{userselect:"click"},deviceProps:{getHeight:function(){}},maxRemainderLength:16},flatUIColors={count:0,colors:["#BF55EC","#F22613","#E87E04","#95A5A6","#1BBC9B","#19B5FE"],getNextColors:function(){return this.colors[this.count++%6]}},moduleLoader={loadModule:function(e){{var o=new $.Deferred;$.ajax({url:"templates/"+e+".html",method:"GET"}).done(function(e){o.resolve(e)}).fail(function(){o.resolve(-1)})}return o.promise()}}; var header=function(){var o=$("#logo"),n=$("#backbutton"),t=$("#middleColumn"),i=$("#rightColumn"),e=function(){c("Next Time"),d("+","getAllContacts"),o.on(configuartion.events.userselect,function(){$("body").trigger("triggerHistory")})},c=function(o){t.html(o)},d=function(o,n){i.html(o),i.off(),n&&i.on(configuartion.events.userselect,function(){$("body").trigger(n)})};e(),$("body").on("showBackButton",function(){n.css("visibility","visible")}),$("body").on("hideBackButton",function(){n.css("visibility","hidden")}),$("body").on("headerMiddle",function(o,n){Logger.info("photo ",n),c(n)}),$("body").on("headerRight",function(o,n,t){d(n,t)})};$("body").on("headerReady",function(o){header(),$(this).off(o)}); var techocall=function(){var e=[],t=0,o=function(){var e=($(window).width(),$(window).height());$(".header > img").height(.1*e);var o=$(".header").outerHeight();t=$(".header").height(),$(".logoText").css("line-height",t+"px");var r=$("#workarea");r.outerHeight(e-o)};$("body").on("addToHistory",function(t,o,r){var i={};i.eventName=o,i.eventArgs=r?r:[],e.push(i)}),$("body").on("triggerHistory",function(){if(e.length>0){var t=e.pop();$("body").trigger(t.eventName,t.eventArgs),0===e.length&&$("body").trigger("hideBackButton")}}),$("body").on("clearHistory",function(){e=[]}),$(document).on("backbutton",function(t){0!=e.length?($("body").trigger("triggerHistory"),t.stopPropagation()):navigator.app.exitApp()}),o()};$(document).on("deviceready",function(){FastClick.attach(document.body),techocall(),$("body").trigger("headerReady"),$("body").trigger("RegisteredContactsReady"),$("body").trigger("ContactsReady"),$("body").trigger("initializeSidebar")}); var registeredContacts=function(){var t=$("#workarea"),e=$('<div class="contact"> <div class="image"> <img id="photo" /> </div> <div class="name"> </div> <div id="deleteContact" class="delete"><img src="img/delete.png" /></div><div style="clear:both"> </div> </div>'),o=function(e){var o=moduleLoader.loadModule("registeredContacts");return o.done(function(o){t.html(o),t.hide(),e.resolve()}),e.promise()},n=function(o){$("#count").text(o.contacts.length);for(var n=t.find("#contacts"),r=0;r<o.contacts.length;r++){var a=e.clone(),i=o.contacts[r];a.attr("id",i.id);var c=a.find(".name");c.text(i.displayName);var d=a.find("#photo");d.attr("src",i.photo),a.data("phoneNumber",i.phoneNumber),n.append(a)}},r=function(){notification("Error loading contacts")},a=function(){techoStorage.getAllContacts(n,r,[])},i=function(t){var e=$("#count").text()-t.length;$("#count").text(e);for(var o=0;o<t.length;o++)$("#"+t[o]).remove()},c=function(t){notification("An error occured while deleting contacts : "+t)},d=function(){var e=t.height(),o=t.find(".addContact").outerHeight(),n=t.find(".wrapper");n.height(e-o)};$("body").on("showTechoContacts",function(){$("body").trigger("clearHistory");var e=new $.Deferred;o(e),e.done(function(){d(),t.show(),a(),$("#version").text(window.location.hash)})}),$("body").on(configuartion.events.userselect,"#getAllContacts",function(){if($(".contact").length>=1){var t="<div>Only 1 contact can be included in Trial Version</div>",e="Trial Version";$("body").trigger("addToHistory",["modalClose"]),alert(t,e)}else $("body").trigger("getAllContacts")}),$("body").on(configuartion.events.userselect,"#settings",function(){$("body").trigger("settings")}),$("body").on(configuartion.events.userselect,"#deleteContact",function(t){var e=t.currentTarget;e=$(e).parent();var o={};o.contactIds=[],o.contactIds.push(e.attr("id")),techoStorage.deleteContacts(i,c,[o]),t.stopPropagation()}),$("body").on("taphold",".contact",function(t){var e=t.currentTarget;e=$(e);var o=e.attr("selected");o?(e.removeAttr("selected"),e.removeClass("selected")):(e.attr("selected","selected"),e.addClass("selected"));var n=$(".contact[selected=selected]");$("body").trigger(0===n.length?"hideSidebar":"showSidebar")}),$("body").on(configuartion.events.userselect,".contact",function(t){var e=$(t.currentTarget),o=e.attr("id"),n=e.find(".name").text(),r=e.find("img").attr("src"),a=e.data("phoneNumber");a=JSON.parse(a);var i={};i.id=o,i.name=n,i.photo=r,i.phoneNumber=a,$("body").trigger("showRemainders",[JSON.stringify(i)])})};$("body").on("RegisteredContactsReady",function(t){registeredContacts(),$("body").trigger("showTechoContacts"),$(this).off(t)}); var showAndRemainders=function(){var e=$("#workarea"),n={},i=$("<div class='remainderItem'> <div class='remainderInfo'> <div class='remainderMessagePreview'> </div> <div class='lastShown'>(Last shown : <span id='lastShown'></span>)</div> </div><div class='remainderControls'><div class='edit'><img src='img/edit.png' /> </div><div id='deleteRemainder' class='delete'><img src='img/delete.png' /></div></div><div style='clear:both'> </div></div>"),r=function(n){e=$("#workarea");var i=moduleLoader.loadModule("showRemainders");i.done(function(i){e.html(i),n.resolve()})},t=function(e){if(e&&e.userRemainders){if(0==e.userRemainders.length)return void $("#nodata").show();for(var n=$(".remainders").show(),r=new Date,t=r.getTime()/1e3,d=(r.getYear(),0);d<e.userRemainders.length;d++){var o=e.userRemainders[d],s=i.clone();if(s.data("remainder",JSON.stringify(o)),s.attr("id",o.remainderId),s.find(".remainderMessagePreview").text(o.remainderMessage),o.isRemainded){var g,m=new Date(o.remaindedOn),c=m.getTime()/1e3,f=m.getHours(),h=12>f?" AM ":" PM ";f=13>f?f:f-12,f=0===f?12:f,g=2592e3>t-c?f+" : "+m.getMinutes()+" : "+m.getSeconds()+h+" - "+m.getDate()+" : "+m.getMonth()+1:7776e3>t-c?f+" : "+m.getMinutes()+" - "+m.toDateString():m.toDateString(),s.find("#lastShown").text(g)}else s.find("#lastShown").text("Never!");n.append(s)}}else a("Nothing to display")},a=function(){$("#error").show()},d=function(e){techoStorage.getAllRemaindersById(t,a,[e])},o=function(e){for(var n=0;n<e.length;n++)$("#"+e[n]).remove()},s=function(){notification("An error occured while deleting remainders")},g=function(){var n=e.find(".user");n.height(n.height());var i=e.find(".remainderItem");i.height(i.height());e.find("#newLine").height();e.find(".remainders").height(.85*(e.height()-(n.height()+e.find(".userMessage").height())))};$("body").on("showRemainders",function(i,t){var a=new $.Deferred;$("body").trigger("addToHistory",["showTechoContacts"]),n=JSON.parse(t),r(a),a.done(function(){e.find("#profile").attr("src",n.photo),e.find("#name").text(n.name),d(n.id),g()})});var m=function(e){var n=$(".remainders").show(),r=i.clone();if(r.data("remainder",JSON.stringify(e)),r.attr("id",e.remainderId),r.find(".remainderMessagePreview").text(e.remainderMessage),e.isRemainded){var t=new Date(e.remaindedOn),a=t.getHours()+" : "+t.getMinutes()+" : "+t.getSeconds()+" - "+t.toDateString();r.find("#lastShown").text(a)}else r.find("#lastShown").text("Never!");n.append(r)},c=function(){notification("Error creating...")},f=function(n){e.find("#"+n.remainderId).find(".remainderMessagePreview").text(n.remainderMessage)},h=function(){notification("Error updating...")},u=function(i){var r=e.find("#note").clone(),t=r.find("#indicator"),a=r.find("#background"),d=r.find("textarea");d.attr("maxlength",configuartion.maxRemainderLength),d.on("keyup",function(){var e=d.val();return e.length<=configuartion.maxRemainderLength?void a.width(e.length/configuartion.maxRemainderLength*100+"%"):(d.val(e.substr(0,e.length-1)),!1)});var o=!1;i?(i=JSON.parse(i),d.val(i.remainderMessage),a.width(d.val().length/configuartion.maxRemainderLength*100+"%")):(i={},i.remainderId=(new Date).getTime(),i.contactId=n.id,i.remainderType=0,i.isRemainded=!1,i.remaindedOn=0,i.remaindedUsing=-1,o=!0);var s=r.find("#ok");s.data("remainder",JSON.stringify(i)),s.data("remainder",o),s.on(configuartion.events.userselect,function(e){return i.remainderMessage=d.val(),i.remainderMessage&&""!=i.remainderMessage?($(this).off(e),s.focus(),r.hide(),$(window).unbind("scroll"),$("body").trigger("triggerHistory"),void(o?techoStorage.addRemainder(m,c,[i]):techoStorage.updateRemainder(f,h,[i]))):!1}),r.show(),confirm(r,e,"","modalClass"),$(window).on("scroll",function(){$(window).scrollTop(0)}),$("body").trigger("addToHistory",["confirmClose"]),setTimeout(function(){d.height(d.height()),d.focus();var e=t.outerHeight(),n=t.height();s.height(e),a.height(n),a.css("top","-"+e+"px"),a.show()},100)};$("body").on(configuartion.events.userselect,"#newLine",function(){u()}),$("body").on(configuartion.events.userselect,".edit",function(e){var n=$(e.currentTarget).parent().parent(),i=n.data("remainder");u(i)}),$("body").on(configuartion.events.userselect,"#deleteRemainder",function(e){var n=$(e.currentTarget).parent().parent(),i={};i.remainderIds=[],i.remainderIds.push(n.attr("id")),techoStorage.deleteRemainders(o,s,[i]),e.stopPropagation()}),$("body").on(configuartion.events.userselect,"#dummyInput",function(){$("body").trigger("addToHistory",["showRemainders"[JSON.stringify(n)]]),n.readOnly=!1,$("body").trigger("note",[JSON.stringify(n)])}),$("body").on("toUserInfo",function(){$("body").trigger("addToHistory",["showRemainders"[JSON.stringify(n)]]),$("body").trigger("userInfo",[JSON.stringify(n)])})}(); var contacts=function(){var t=$("#workarea"),o=void 0,n=void 0,e=void 0,a=$("<div class='row'><img height='100%' /> <span id='name'></span> </div>"),i=function(e){var a=moduleLoader.loadModule("allContacts");return a.done(function(a){t.html(a),o=t.find("#search"),n=t.find("#userInfo"),e.resolve()}),e.promise()},r=function(){var o=$("header").height(),n=$("header > div");n.height(o),n.css("line-height",o+"px"),$("#contact").height(.08*t.height()),a.height($("#contact").height()),a.css("line-height",$("#contact").height()+"px"),$(".message").height($(".message").height()),$(".message").css("line-height",$(".message").height()+"px")};$("body").on("getAllContacts",function(){var o=new $.Deferred;$("body").trigger("addToHistory",["showTechoContacts"]),i(o),o.done(function(){r(),t.find(".message").show(),$("#contact").focus(),setTimeout(function(){$("#contact").focus()},1e3)})}),$("body").on("blur","#contact",function(){$(window).unbind("scroll")}),$("body").on("focus","#contact",function(){g(),o.show(),$(window).on("scroll",function(){$(window).scrollTop(0)})}),$("body").on("keyup","#contact",function(t){var o=t.target.value;0!=o.length&&o.length>=3&&c(o)});var c=function(t){var o=new ContactFindOptions;o.filter=t,o.multiple=!0;var n=["id","displayName","photos","phoneNumbers"];e=(new Date).getTime(),$("#load").css("visibility","visible").width("25%"),navigator.contacts.find(n,s,d,o,e)},s=function(t,o){var n=$("#load");if(o==e){n.width("50%"),g();var a=[];if(t&&0!==t.length){for(var i=50/t.length,r=0;r<t.length;r++)if(t[r].displayName&&"null"!=t[r].displayName&&t[r].phoneNumbers&&"null"!=t[r].phoneNumbers){var c={};c.name=t[r].displayName,c.id=t[r].id,c.photo=t[r].photos;for(var s=[],d=t[r].phoneNumbers,u=0;u<d.length;u++){var l=d[u];if(l.value){var f={},p=l.value.replace(/\D/g,"").match(/\d{10}$/);f.number=p&&p[0]?p[0]:"0000000000",f.type=l.type,s.push(f)}}c.phoneNumber=s,a.push(c)}n.width(50+i*r+"%")}else{var c={};c.name="No Result",a.push(c)}if(0===a.length){var c={};c.name="No Result",a.push(c)}h(a),n.width("100%"),setTimeout(function(){n.css("visibility","hidden")},500)}},d=function(){timeStamp==e&&(load.css("visibility","hidden"),g(),notification("Error fetching contacts"))},h=function(t){for(var n=0;n<t.length;n++){var e=t[n],i=a.clone();if(e.id){i.attr("id",e.id),e.photo=e.photo&&e.photo[0]?e.photo[0].value:"img/photo.jpg";var r=i.find("img");i.data("json",JSON.stringify(e)),r.attr("src",e.photo),r[0].onerror=function(t){var o=t.currentTarget,o=$(o);o.attr("src","img/photo.jpg"),o=o.parent();var n=o.data("json");n=JSON.parse(n),n.photo="img/photo.jpg",o.data("json",JSON.stringify(n))}}i.find("#name").text(e.name),o.append(i)}};$("body").on("error",".row > img",function(t){var o=t.currentTarget,o=$(o);o.attr("src","img/photo.jpg"),o=o.parent();var n=o.data("json");n=JSON.parse(n),n.photo="img/photo.jpg",o.data("json",JSON.stringify(n))});var g=function(){o.empty()};$("body").on("toUser",function(){var t=$("#contact").data("json");techoStorage.addContact(u,l,[t])});var u=function(t){$("body").trigger("showRemainders",[JSON.stringify(t)])},l=function(){g(),h("Error creating")};$("body").on(configuartion.events.userselect,".row",function(o){var n=$(o.currentTarget);if(n.attr("id")){$("#contact").val(n.text());var e=n.data("json");$("#contact").data("json",JSON.parse(e));var a=JSON.parse(e),i=t.find("#addContact").clone();$("#contact").blur();var r=i.find("#addTickUser");r.text(a.name),i.show(),confirm(i,t,"contactOverlay"),$("body").trigger("addToHistory",["confirmClose"]),$("body").on("confirmClose",function(){i.hide()}),r.on(configuartion.events.userselect,function(){i.hide(),$("body").trigger("confirmClose");var t=$("#contact").data("json");techoStorage.addContact(u,l,[t])})}})}();$("body").on("ContactsReady",function(){}); var settings=function(){var t=$("#workarea"),e=!1,o=function(e){var o=moduleLoader.loadModule("settings");return o.done(function(o){t.html(o),e.resolve()}),e.promise()},n=function(e){if(e)for(var o=0;o<e.length;o++){var n=e[o],i=(n.name,n.value),r=n.id;0==i?t.find("#"+r).removeAttr("checked"):t.find("#"+r).attr("checked","checked")}},i=function(t){notification("Error while loading settings"+t)};$("body").on("settings",function(){var t=new $.Deferred;$("body").trigger("addToHistory",["showTechoContacts"]),o(t),t.done(function(){techoStorage.getSettings(n,i,[])})});var r=function(){e=!1},a=function(){e=!1,notification("Error updating preferences")},c=function(t,o){var n=o.find("input").attr("checked")?0:1,i={id:t,value:n};e=!0,techoStorage.updateSettings(r,a,[i])},d=function(){var t="<div>Version "+window.location.hash+"</div><div>techostic@gmail.com</div>",e="About Next Talk";$("body").trigger("addToHistory",["modalClose"]),alert(t,e)};$("body").on(configuartion.events.userselect,".item",function(t){if(!e){var o=$(t.currentTarget),n=o.attr("for");switch(n){case"about":d();break;default:c(n,o)}}})}();
